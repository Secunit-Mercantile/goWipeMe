name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

env:
  WAILS_VERSION: v2.11.0

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run tests
        run: go test -v ./internal/...

  build-tui-macos-intel:
    name: Build TUI (macOS Intel)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build TUI
        env:
          GOOS: darwin
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -trimpath -o gowipeme ./cmd/gowipeme

  build-tui-macos-apple-silicon:
    name: Build TUI (macOS Apple Silicon)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build TUI
        env:
          GOOS: darwin
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -trimpath -o gowipeme ./cmd/gowipeme

  build-tui-linux-amd64:
    name: Build TUI (Linux AMD64)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Verify we're building TUI, not GUI
        run: |
          echo "Building TUI (Terminal Interface) for linux/amd64"
          echo "Command: go build ./cmd/gowipeme"
          echo "NOT using: wails build"
          
      - name: Build TUI
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          which go
          go version
          echo "Building TUI binary..."
          go build -ldflags="-s -w" -trimpath -o gowipeme ./cmd/gowipeme
          if [ -f gowipeme ]; then
            echo "✓ TUI build successful: $(ls -lh gowipeme)"
            file gowipeme
          else
            echo "✗ TUI build failed - binary not found"
            exit 1
          fi

  build-tui-linux-arm64:
    name: Build TUI (Linux ARM64)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build TUI
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -trimpath -o gowipeme ./cmd/gowipeme

  build-tui-linux-riscv64:
    name: Build TUI (Linux RISC-V 64)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build TUI
        env:
          GOOS: linux
          GOARCH: riscv64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -trimpath -o gowipeme ./cmd/gowipeme

  build-tui-windows-amd64:
    name: Build TUI (Windows AMD64)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build TUI
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -trimpath -o gowipeme.exe ./cmd/gowipeme

  build-gui-macos-universal:
    name: Build GUI (macOS Universal)
    needs: test
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build GUI
        run: |
          wails build -clean -platform darwin/universal -ldflags="-s -w" -trimpath -o gowipeme-gui

  build-gui-macos-intel:
    name: Build GUI (macOS Intel)
    needs: test
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build GUI
        run: |
          wails build -clean -platform darwin/amd64 -ldflags="-s -w" -trimpath -o gowipeme-gui

  build-gui-macos-apple-silicon:
    name: Build GUI (macOS Apple Silicon)
    needs: test
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build GUI
        run: |
          wails build -clean -platform darwin/arm64 -ldflags="-s -w" -trimpath -o gowipeme-gui

  build-gui-linux-amd64:
    name: Build GUI (Linux AMD64)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          # Wails looks for webkit2gtk-4.0, but Ubuntu has 4.1 - create symlink
          if [ -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc ] && [ ! -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -s /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          fi
          # Also check for arm64 path
          if [ -f /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc ] && [ ! -f /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -s /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          fi
          pkg-config --exists webkit2gtk-4.0 && echo "✓ webkit2gtk-4.0 found" || echo "⚠ webkit2gtk-4.0 not found, checking available versions:" && pkg-config --list-all | grep webkit || true

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build GUI
        run: |
          wails build -clean -platform linux/amd64 -ldflags="-s -w" -trimpath -o gowipeme-gui

  build-gui-linux-arm64:
    name: Build GUI (Linux ARM64)
    needs: test
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          # Wails looks for webkit2gtk-4.0, but Ubuntu ships 4.1 - create symlink if needed
          if [ -f /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc ] && [ ! -f /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -s /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          fi
          pkg-config --exists webkit2gtk-4.0 && echo "✓ webkit2gtk-4.0 found" || (echo "⚠ webkit2gtk-4.0 not found" && pkg-config --list-all | grep webkit || true)

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build GUI
        run: |
          wails build -clean -platform linux/arm64 -ldflags="-s -w" -trimpath -o gowipeme-gui

  build-gui-linux-riscv64:
    name: Build GUI (Linux RISC-V 64)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          # Wails looks for webkit2gtk-4.0, but Ubuntu has 4.1 - create symlink
          if [ -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc ] && [ ! -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -s /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          fi
          # Also check for arm64 path
          if [ -f /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc ] && [ ! -f /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
            sudo ln -s /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc
          fi
          pkg-config --exists webkit2gtk-4.0 && echo "✓ webkit2gtk-4.0 found" || echo "⚠ webkit2gtk-4.0 not found, checking available versions:" && pkg-config --list-all | grep webkit || true

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build GUI
        continue-on-error: true
        run: |
          wails build -clean -platform linux/riscv64 -ldflags="-s -w" -trimpath -o gowipeme-gui

  build-gui-windows-amd64:
    name: Build GUI (Windows AMD64)
    needs: test
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install Bun
        run: |
          powershell -c "irm bun.sh/install.ps1 | iex"
          echo "$env:USERPROFILE\.bun\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && bun install

      - name: Build GUI
        run: |
          wails build -clean -platform windows/amd64 -ldflags="-s -w" -trimpath -o gowipeme-gui.exe

